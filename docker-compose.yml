services:
  # ==========================================================================
  # Redis - Session & Cache Management
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # PostgreSQL + PGVector - Unified Database
  # ==========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-db-hetzner.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      - POSTGRES_USER=openwebui
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-openwebui-secret}
      - POSTGRES_DB=openwebui
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openwebui -d openwebui"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Ollama - Local LLM Server
  # ==========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    restart: unless-stopped

  # ==========================================================================
  # Open WebUI v0.7 - Main Application
  # ==========================================================================
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "3000:8080"
    volumes:
      - open-webui-data:/app/backend/data
    environment:
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      # Ollama connection (local LLMs)
      - OLLAMA_BASE_URL=http://ollama:11434
      # OpenAI connection (cloud LLMs)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Enable local signup (first user becomes admin)
      - ENABLE_SIGNUP=true
      # User headers for MCP Proxy
      - ENABLE_FORWARD_USER_INFO_HEADERS=true
      - BYPASS_MODEL_ACCESS_CONTROL=true
      # Redis for sessions and caching
      - REDIS_URL=redis://redis:6379/0
      - ENABLE_REDIS=true
      # PostgreSQL Database (single database for everything)
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD:-openwebui-secret}@postgres:5432/openwebui
      # PGVector for RAG embeddings
      - VECTOR_DB=pgvector
      - PGVECTOR_CONNECTION_STRING=postgresql://openwebui:${POSTGRES_PASSWORD:-openwebui-secret}@postgres:5432/openwebui
      # Microsoft Entra ID OAuth
      - ENABLE_OAUTH_SIGNUP=true
      - OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
      - MICROSOFT_CLIENT_TENANT_ID=${MICROSOFT_CLIENT_TENANT_ID}
      # Group Management for Multi-Tenant
      - ENABLE_OAUTH_GROUP_MANAGEMENT=true
      - ENABLE_OAUTH_GROUP_CREATION=true
      - OAUTH_GROUP_CLAIM=groups
      # Role Management (MCP-Admin group = admin role)
      - ENABLE_OAUTH_ROLE_MANAGEMENT=true
      - OAUTH_ADMIN_ROLES=MCP-Admin
      # Enable Workspaces for multi-tenant (from Kubernetes config)
      - ENABLE_WORKSPACE=true
      # =======================================================================
      # SINGLE PROXY AUTO-DEPLOY: Pre-configure MCP Proxy at startup
      # =======================================================================
      # This is Lukas's requirement: configure tools BEFORE Open WebUI starts
      # Format for Open WebUI v0.7.2 with required key and config fields
      # auth_type: "session" sends JWT for user identification
      - 'TOOL_SERVER_CONNECTIONS=[{"type":"openapi","url":"http://mcp-proxy:8000","path":"openapi.json","auth_type":"session","key":"mcp-proxy","config":{"enable":true},"info":{"id":"mcp-proxy","name":"MCP Proxy","description":"Single proxy for all MCP servers"}}]'
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    restart: unless-stopped

  # ==========================================================================
  # MCP Proxy Gateway - Multi-Tenant Tool Filtering
  # ==========================================================================
  mcp-proxy:
    build: ./mcp-proxy
    container_name: mcp-proxy
    ports:
      - "8000:8000"
    environment:
      - DEBUG=true
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      # Database connection for permission lookups
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD:-openwebui-secret}@postgres:5432/openwebui
      # MCP Server URLs (Docker Compose service discovery)
      - MCP_FILESYSTEM_URL=http://mcp-filesystem:8001
      - MCP_GITHUB_URL=http://mcp-github:8000
      - MCP_EXCEL_URL=http://mcp-excel:8000
      - MCP_DASHBOARD_URL=http://mcp-dashboard:8000
      # API Gateway Mode - trust headers from Traefik/auth-service
      - API_GATEWAY_MODE=true
      - TRUSTED_PROXY_HEADERS=X-User-Email,X-User-Groups
      # API key for authenticating with MCP servers
      - MCP_API_KEY=${MCP_API_KEY:-test-key}
      # =======================================================================
      # MCP Server API Keys (from Kubernetes config - for future servers)
      # =======================================================================
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - LINEAR_API_KEY=${LINEAR_API_KEY}
      - NOTION_API_KEY=${NOTION_API_KEY}
      - ATLASSIAN_TOKEN=${ATLASSIAN_TOKEN}
      - ASANA_TOKEN=${ASANA_TOKEN}
      - HUBSPOT_API_KEY=${HUBSPOT_API_KEY}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - GITLAB_TOKEN=${GITLAB_TOKEN}
      - SENTRY_AUTH_TOKEN=${SENTRY_AUTH_TOKEN}
      - DATADOG_API_KEY=${DATADOG_API_KEY}
      - GRAFANA_API_KEY=${GRAFANA_API_KEY}
      - SNYK_TOKEN=${SNYK_TOKEN}
      - SONARQUBE_TOKEN=${SONARQUBE_TOKEN}
      - SONARQUBE_URL=${SONARQUBE_URL}
      # Microsoft Graph (OneDrive, SharePoint, Teams)
      - MICROSOFT_GRAPH_TOKEN=${MICROSOFT_GRAPH_TOKEN}
    depends_on:
      postgres:
        condition: service_healthy
      mcp-filesystem:
        condition: service_started
      mcp-github:
        condition: service_started
      mcp-excel:
        condition: service_started
      mcp-dashboard:
        condition: service_started
    restart: unless-stopped

  # ==========================================================================
  # MCP Filesystem Server - File Access Tools
  # ==========================================================================
  mcp-filesystem:
    image: node:20-slim
    container_name: mcp-filesystem
    command: >
      bash -c "apt-get update && apt-get install -y python3 python3-pip curl --no-install-recommends &&
               pip3 install --break-system-packages mcpo &&
               mcpo --host 0.0.0.0 --port 8001 --api-key test-key -- npx -y @modelcontextprotocol/server-filesystem /data"
    ports:
      - "8001:8001"
    volumes:
      - ./mcp-data:/data
    restart: unless-stopped

  # ==========================================================================
  # MCP GitHub Server - GitHub API Tools
  # ==========================================================================
  mcp-github:
    build: ./mcp-servers/github
    container_name: mcp-github
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN}
      - MCP_API_KEY=${MCP_API_KEY:-test-key}
    ports:
      - "8002:8000"
    restart: unless-stopped

  # ==========================================================================
  # MCP Excel Creator - Spreadsheet Generation Tools
  # ==========================================================================
  mcp-excel:
    build: ./mcp-servers/excel-creator
    container_name: mcp-excel
    ports:
      - "8003:8000"
    restart: unless-stopped

  # ==========================================================================
  # MCP Dashboard - Executive Dashboard Generation Tools
  # ==========================================================================
  mcp-dashboard:
    build: ./mcp-servers/dashboard
    container_name: mcp-dashboard
    ports:
      - "8004:8000"
    restart: unless-stopped

  # ==========================================================================
  # TIER 2: SSE MCP Servers
  # ==========================================================================
  mcpo-sse-atlassian:
    image: ghcr.io/sooperset/mcp-atlassian:latest
    container_name: mcpo-sse-atlassian
    command: ["--transport", "streamable-http", "--port", "8010", "-vv"]
    ports:
      - "8010:8010"
    environment:
      - ATLASSIAN_OAUTH_ENABLE=true
      - ATLASSIAN_API_TOKEN=${ATLASSIAN_TOKEN}
    restart: unless-stopped

  mcpo-sse-asana:
    image: python:3.11-slim
    container_name: mcpo-sse-asana
    command: >
      bash -c "apt-get update && apt-get install -y curl nodejs npm --no-install-recommends &&
               pip install mcpo mcp-remote --quiet &&
               mcpo --host 0.0.0.0 --port 8011 --api-key ${MCP_API_KEY:-test-key} -- npx -y mcp-remote https://mcp.asana.com/sse"
    ports:
      - "8011:8011"
    environment:
      - MCP_API_KEY=${MCP_API_KEY:-test-key}
      - ASANA_TOKEN=${ASANA_TOKEN}
    restart: unless-stopped

  # ==========================================================================
  # TIER 3: STDIO MCP Servers
  # ==========================================================================
  mcpo-stdio-sonarqube:
    image: node:20-slim
    container_name: mcpo-stdio-sonarqube
    command: >
      bash -c "apt-get update && apt-get install -y python3 python3-pip --no-install-recommends &&
               pip3 install --break-system-packages mcpo &&
               mcpo --host 0.0.0.0 --port 8020 --api-key ${MCP_API_KEY:-test-key} -- npx -y @anthropic/mcp-sonarqube"
    ports:
      - "8020:8020"
    environment:
      - MCP_API_KEY=${MCP_API_KEY:-test-key}
      - SONARQUBE_URL=${SONARQUBE_URL}
      - SONARQUBE_TOKEN=${SONARQUBE_TOKEN}
    restart: unless-stopped

  # ==========================================================================
  # Database Init - Seeds group_tenant_mapping from mcp-servers.json
  # ==========================================================================
  # This is the SINGLE PROXY key: ONE config file -> database at deploy time
  db-init:
    build: ./mcp-proxy
    container_name: db-init
    command: ["python", "/app/scripts/seed_mcp_servers.py", "--clear"]
    environment:
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD:-openwebui-secret}@postgres:5432/openwebui
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"  # Run once and exit

volumes:
  redis-data:
  postgres-data:
  ollama-data:
  open-webui-data:
