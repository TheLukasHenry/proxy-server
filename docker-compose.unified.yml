# =============================================================================
# MCP Proxy - Unified Deployment with API Gateway
# =============================================================================
#
# Complete stack with centralized authentication and rate limiting.
#
# Architecture:
#   Browser -> Caddy (port 80) -> API Gateway -> Backend Services
#
# Services:
#   - caddy: Reverse proxy and TLS termination
#   - api-gateway: JWT validation, rate limiting, user header injection
#   - mcp-proxy: MCP tool orchestration (API_GATEWAY_MODE=true)
#   - open-webui: AI chat interface
#   - admin-portal: User/group management UI
#   - postgres: Database
#   - redis: Sessions and cache
#   - MCP servers: Tool containers
#
# Usage:
#   docker compose -f docker-compose.unified.yml up -d
#
# =============================================================================

services:
  # ===========================================================================
  # CADDY - Reverse Proxy
  # ===========================================================================
  # Entry point for all traffic. Routes to API Gateway.
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - api-gateway
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # API GATEWAY - Centralized Auth & Rate Limiting
  # ===========================================================================
  # Validates JWTs, looks up user groups, applies rate limits, forwards headers.
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8085:8080"
    restart: unless-stopped
    environment:
      # JWT validation (same key as Open WebUI)
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      # Database for group lookups and analytics
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD}@postgres:5432/openwebui
      # Rate limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_PER_MINUTE=500
      - RATE_LIMIT_PER_IP=5000
      # Analytics logging
      - ENABLE_API_ANALYTICS=true
      # Backend service URLs
      - MCP_PROXY_URL=http://mcp-proxy:8000
      - ADMIN_PORTAL_URL=http://admin-portal:8080
      - OPEN_WEBUI_URL=http://open-webui:8080
      # Debug mode
      - DEBUG=${DEBUG:-false}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/gateway/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # Webhook Handler - External event processing
  # ==========================================================================
  webhook-handler:
    build: ./webhook-handler
    container_name: webhook-handler
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - PORT=8086
      - DEBUG=${DEBUG:-false}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - OPENWEBUI_URL=http://open-webui:8080
      - OPENWEBUI_API_KEY=${OPENWEBUI_API_KEY:-}
      - AI_MODEL=${AI_MODEL:-gpt-4-turbo}
      - MCP_PROXY_URL=http://mcp-proxy:8000
      - MCP_USER_EMAIL=webhook-handler@system
      - MCP_USER_GROUPS=MCP-Admin
      - AUTOMATION_PIPE_MODEL=${AUTOMATION_PIPE_MODEL:-webhook_automation.webhook-automation}
      - N8N_URL=${N8N_API_URL:-https://n8n.srv1041674.hstgr.cloud}
      - N8N_API_KEY=${N8N_API_KEY:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET:-}
    networks:
      - backend
    depends_on:
      - open-webui
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8086/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # n8n - Workflow Automation
  # ==========================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-}
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://ai-ui.coolestdomain.win/n8n/}
      - N8N_RESTRICT_ENVIRONMENT_VARIABLES_ACCESS=false
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      # Secrets for n8n workflow nodes
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OPENWEBUI_API_KEY=${OPENWEBUI_API_KEY}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - backend

  # ===========================================================================
  # MCP PROXY - Multi-Tenant Tool Gateway
  # ===========================================================================
  # Tool orchestration with multi-tenant filtering.
  # API_GATEWAY_MODE=true: Trusts headers from API Gateway.
  mcp-proxy:
    build: ./mcp-proxy
    container_name: mcp-proxy
    restart: unless-stopped
    environment:
      - DEBUG=${DEBUG:-false}
      # =======================================================================
      # API GATEWAY MODE - Trust headers from gateway
      # =======================================================================
      - API_GATEWAY_MODE=true
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      - TRUSTED_PROXY_HEADERS=X-User-Email,X-User-Groups,X-User-Admin
      # Database for permission lookups
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD}@postgres:5432/openwebui
      # MCP Server URLs (Docker internal network)
      - MCP_FILESYSTEM_URL=http://mcp-filesystem:8001
      - MCP_GITHUB_URL=http://mcp-github:8000
      - MCP_CLICKUP_URL=http://mcp-clickup:8000
      - MCP_TRELLO_URL=http://mcp-trello:8000
      - MCP_SONARQUBE_URL=http://mcp-sonarqube:8000
      - MCP_EXCEL_URL=http://mcp-excel:8000
      - MCP_DASHBOARD_URL=http://mcp-dashboard:8000
      - MCP_NOTION_URL=http://mcp-notion:8000
      - MCP_N8N_URL=http://mcp-n8n:8000
      # API Keys
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - CLICKUP_API_TOKEN=${CLICKUP_API_TOKEN:-}
      - TRELLO_API_KEY=${TRELLO_API_KEY:-}
      - SONARQUBE_TOKEN=${SONARQUBE_TOKEN:-}
      - SONARQUBE_URL=${SONARQUBE_URL:-}
      - LINEAR_API_KEY=${LINEAR_API_KEY:-}
      - NOTION_API_KEY=${NOTION_API_KEY:-}
      - N8N_API_KEY=${N8N_API_KEY:-}
      # Meta-tools mode
      - META_TOOLS_MODE=${META_TOOLS_MODE:-false}
      # Skip cache refresh on startup (faster boot)
      - SKIP_CACHE_REFRESH=${SKIP_CACHE_REFRESH:-false}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # OPEN WEBUI - AI Chat Interface
  # ===========================================================================
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:8080"
    volumes:
      - open-webui-data:/app/backend/data
    environment:
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      # LLM Connections
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-}
      - ENABLE_OLLAMA_API=${ENABLE_OLLAMA_API:-false}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_API_BASE_URL=${OPENAI_API_BASE_URL:-}
      # Database
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD}@postgres:5432/openwebui
      - VECTOR_DB=pgvector
      - PGVECTOR_CONNECTION_STRING=postgresql://openwebui:${POSTGRES_PASSWORD}@postgres:5432/openwebui
      # Redis
      - REDIS_URL=redis://redis:6379/0
      - ENABLE_REDIS=true
      # Microsoft OAuth
      - ENABLE_OAUTH_SIGNUP=true
      - DEFAULT_USER_ROLE=user
      - ENABLE_LOGIN_FORM=true
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID:-}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET:-}
      - MICROSOFT_CLIENT_TENANT_ID=${MICROSOFT_TENANT_ID:-consumers}
      - MICROSOFT_REDIRECT_URI=${WEBUI_URL:-http://localhost}/oauth/microsoft/callback
      - OPENID_PROVIDER_URL=${OPENID_PROVIDER_URL:-}
      - OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
      - WEBUI_URL=${WEBUI_URL:-http://localhost}
      # Group Management
      - ENABLE_OAUTH_GROUP_MANAGEMENT=true
      - ENABLE_OAUTH_GROUP_CREATION=true
      - OAUTH_GROUP_CLAIM=groups
      # Role Management
      - ENABLE_OAUTH_ROLE_MANAGEMENT=true
      - OAUTH_ADMIN_ROLES=MCP-Admin
      # Workspaces
      - ENABLE_WORKSPACE=true
      # User headers (forwarded by gateway)
      - ENABLE_FORWARD_USER_INFO_HEADERS=true
      - BYPASS_MODEL_ACCESS_CONTROL=true
      # =======================================================================
      # MCP Proxy Connection
      # =======================================================================
      # Use "session" auth_type so Open WebUI sends JWT to MCP Proxy
      # The gateway will validate it and forward user headers
      - 'TOOL_SERVER_CONNECTIONS=[{"type":"openapi","url":"http://mcp-proxy:8000","path":"/openapi.json","auth_type":"session","key":"mcp-proxy","config":{"enable":true},"info":{"id":"mcp-proxy","name":"MCP Proxy","description":"Single proxy for all MCP servers"}}]'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend

  # ===========================================================================
  # ADMIN PORTAL - User/Group Management
  # ===========================================================================
  admin-portal:
    build: ./admin-portal
    container_name: admin-portal
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD}@postgres:5432/openwebui
      - SECRET_KEY=${WEBUI_SECRET_KEY}
      - ADMIN_EMAILS=${ADMIN_EMAILS:-admin@example.com}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend

  # ===========================================================================
  # POSTGRESQL - Database
  # ===========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: postgres
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-db-hetzner.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      - POSTGRES_USER=openwebui
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=openwebui
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openwebui -d openwebui"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  # ===========================================================================
  # REDIS - Sessions & Cache
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  # ===========================================================================
  # MCP SERVERS - Tool Containers
  # ===========================================================================

  # Filesystem - File access tools (14 tools)
  mcp-filesystem:
    image: node:20-slim
    container_name: mcp-filesystem
    restart: unless-stopped
    command: >
      bash -c "apt-get update && apt-get install -y python3 python3-pip curl --no-install-recommends &&
               pip3 install --break-system-packages mcpo &&
               mcpo --host 0.0.0.0 --port 8001 --api-key $${MCP_API_KEY} -- npx -y @modelcontextprotocol/server-filesystem /data"
    environment:
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
    volumes:
      - ./mcp-data:/data
    networks:
      - backend

  # GitHub - Repository tools (26 tools)
  mcp-github:
    build: ./mcp-servers/github
    container_name: mcp-github
    restart: unless-stopped
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN}
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
    networks:
      - backend

  # ClickUp - Task management (177+ tools)
  mcp-clickup:
    image: node:20-slim
    container_name: mcp-clickup
    restart: unless-stopped
    command: >
      bash -c "apt-get update && apt-get install -y python3 python3-pip curl --no-install-recommends &&
               pip3 install --break-system-packages mcpo &&
               mcpo --host 0.0.0.0 --port 8000 --api-key $${MCP_API_KEY} -- npx -y @chykalophia/clickup-mcp-server"
    environment:
      - CLICKUP_API_TOKEN=${CLICKUP_API_TOKEN}
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
    networks:
      - backend

  # Trello - Kanban boards
  mcp-trello:
    image: node:20-slim
    container_name: mcp-trello
    restart: unless-stopped
    command: >
      bash -c "apt-get update && apt-get install -y python3 python3-pip curl --no-install-recommends &&
               pip3 install --break-system-packages mcpo &&
               mcpo --host 0.0.0.0 --port 8000 --api-key $${MCP_API_KEY} -- npx -y mcp-server-trello"
    environment:
      - TRELLO_API_KEY=${TRELLO_API_KEY}
      - TRELLO_TOKEN=${TRELLO_API_TOKEN}
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
    networks:
      - backend

  # SonarQube - Code quality analysis
  mcp-sonarqube:
    image: node:20-slim
    container_name: mcp-sonarqube
    restart: unless-stopped
    command: >
      bash -c "apt-get update && apt-get install -y python3 python3-pip curl --no-install-recommends &&
               pip3 install --break-system-packages mcpo &&
               mcpo --host 0.0.0.0 --port 8000 --api-key $${MCP_API_KEY} -- npx -y @wallacewen/sonarqube-mcp-server"
    environment:
      - SONARQUBE_TOKEN=${SONARQUBE_TOKEN}
      - SONARQUBE_URL=${SONARQUBE_URL:-https://sonarcloud.io}
      - SONARQUBE_ORGANIZATION=${SONARQUBE_ORGANIZATION:-}
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
    networks:
      - backend

  # Excel Creator - Spreadsheet generation
  mcp-excel:
    build: ./mcp-servers/excel-creator
    container_name: mcp-excel
    restart: unless-stopped
    networks:
      - backend

  # Dashboard - Executive dashboard generation
  mcp-dashboard:
    build: ./mcp-servers/dashboard
    container_name: mcp-dashboard
    restart: unless-stopped
    networks:
      - backend

  # Notion - Workspace and documentation
  mcp-notion:
    build: ./mcp-servers/notion
    container_name: mcp-notion
    restart: unless-stopped
    environment:
      - OPENAPI_MCP_HEADERS={"Authorization":"Bearer ${NOTION_API_KEY}","Notion-Version":"2022-06-28"}
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
    networks:
      - backend

  # n8n MCP - AI-driven workflow creation and management (20 tools)
  mcp-n8n:
    build: ./mcp-servers/n8n
    container_name: mcp-n8n
    restart: unless-stopped
    environment:
      - MCP_MODE=stdio
      - N8N_API_URL=${N8N_API_URL:-https://n8n.srv1041674.hstgr.cloud}
      - N8N_API_KEY=${N8N_API_KEY:-}
      - MCP_API_KEY=${MCP_API_KEY:-mcp-secret-key}
      - LOG_LEVEL=error
      - DISABLE_CONSOLE_OUTPUT=true
      - N8N_MCP_TELEMETRY_DISABLED=true
    networks:
      - backend

  # ===========================================================================
  # DATABASE INIT - Seed data from mcp-servers.json
  # ===========================================================================
  db-init:
    build: ./mcp-proxy
    container_name: db-init
    command: ["python", "/app/scripts/seed_mcp_servers.py", "--clear"]
    environment:
      - DATABASE_URL=postgresql://openwebui:${POSTGRES_PASSWORD}@postgres:5432/openwebui
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"
    networks:
      - backend

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  caddy-data:
  caddy-config:
  postgres-data:
  redis-data:
  open-webui-data:
  n8n_data:
