# Session Report — 2026-01-28

## Summary

Completed Phase 2 of the Hetzner Full Parity PRD and implemented Speakeasy Dynamic Toolsets (meta-tools) for smart tool selection.

## What Was Done

### 1. US-008: Progressive Disclosure Research (Phase 3)

Researched 10 approaches for reducing tool overload when 200+ MCP tools are exposed to the LLM. Created comprehensive research document evaluating:

- Speakeasy Dynamic Toolsets (top pick)
- pgvector semantic search
- Open WebUI AutoTool Filter
- Portkey mcp-tool-filter
- LangChain ToolNode
- LlamaIndex FunctionTool
- ScaleMCP routing
- BM25 keyword ranking

**Key finding**: Speakeasy meta-tools pattern achieves 96-99% token reduction with 100% success rate up to 400 tools.

**Output**: `docs/PROGRESSIVE-DISCLOSURE-RESEARCH.md`

### 2. US-004: Database Schema Migration (Phase 2)

Moved all MCP Proxy tables from PostgreSQL `public` schema to isolated `mcp_proxy` schema. This prevents Open WebUI's Alembic migrations from touching our tables.

**Changes**:
- Rewrote `scripts/init-db-hetzner.sql` — all tables now in `mcp_proxy` schema
- Created `scripts/migrate-to-mcp-schema.sql` — idempotent migration for existing deployments
- Updated `mcp-proxy/db.py` — 8 SQL queries prefixed with `mcp_proxy.`
- Updated `admin-portal/main.py` — 15+ SQL queries prefixed with `mcp_proxy.`
- Updated `auth-service/main.py` — 2 queries updated
- Updated `mcp-proxy/scripts/seed_mcp_servers.py` — schema creation + all queries updated

### 3. US-005: Update Safety Documentation (Phase 2)

Created documentation and tooling for safe Open WebUI updates:

- `docs/DATABASE-SCHEMA-SAFETY.md` — Pre-update checklist, update steps, post-update verification, rollback procedure
- `scripts/check-mcp-schema.sh` — Automated schema health check script (run before/after updates)

### 4. US-006: Remote MCP Server Auto-Enable Fix (Phase 2)

Fixed 8 MCP servers in `tenants.py` that were hardcoded `enabled=True` without checking for API keys. Now they auto-enable only when the env var is set:

| Server | Env Var | Pattern |
|---|---|---|
| Linear | `LINEAR_API_KEY` | `enabled=bool(os.getenv("LINEAR_API_KEY"))` |
| Notion | `NOTION_API_KEY` | `enabled=bool(os.getenv("NOTION_API_KEY"))` |
| HubSpot | `HUBSPOT_API_KEY` | `enabled=bool(os.getenv("HUBSPOT_API_KEY"))` |
| Pulumi | `PULUMI_ACCESS_TOKEN` | `enabled=bool(os.getenv("PULUMI_ACCESS_TOKEN"))` |
| GitLab | `GITLAB_TOKEN` | `enabled=bool(os.getenv("GITLAB_TOKEN"))` |
| Sentry | `SENTRY_AUTH_TOKEN` | `enabled=bool(os.getenv("SENTRY_AUTH_TOKEN"))` |
| Asana | `ASANA_TOKEN` | `enabled=bool(os.getenv("ASANA_TOKEN"))` |
| GitHub (local) | `GITHUB_TOKEN` | `enabled=bool(os.getenv("GITHUB_TOKEN"))` |

**Output**: `docs/ADDING-MCP-SERVER-KEYS.md` — Step-by-step guide for adding new API keys

### 5. US-007: Native MCP Research (Phase 2)

Researched Open WebUI v0.7+ native MCP support (Streamable HTTP `type: "mcp"`).

**Key findings**:
- Direct MCP connections bypass our proxy's group-based access control
- Only Streamable HTTP transport is supported natively (not SSE or stdio)
- 5 servers are compatible: Notion, Linear, Sentry, HubSpot, Atlassian
- Recommendation: use direct only for org-wide tools, proxy for per-group isolation

**Output**: `docs/OPEN-WEBUI-NATIVE-MCP.md`

### 6. Speakeasy Meta-Tools Implementation

Implemented the Speakeasy Dynamic Toolsets pattern — 3 meta-tools replace 200+ individual tools:

| Meta-Tool | Endpoint | Purpose |
|---|---|---|
| `search_tools` | `POST /meta/search_tools` | Semantic search via pgvector + fastembed |
| `describe_tools` | `POST /meta/describe_tools` | Lazy-load full parameter schemas |
| `call_tool` | `POST /meta/call_tool` | Execute any tool by name |

**New files**:
- `mcp-proxy/tool_embeddings.py` — Embedding module (BAAI/bge-small-en-v1.5, 384-dim vectors, pgvector cosine similarity, keyword fallback)

**Modified files**:
- `mcp-proxy/main.py` — 4 new endpoints, `META_TOOLS_MODE` toggle, embedding generation in `refresh_tools_cache()`
- `mcp-proxy/requirements.txt` — Added `fastembed>=0.4.0`
- `scripts/init-db-hetzner.sql` — Added `mcp_proxy.tool_embeddings` table with `vector(384)` column
- `docker-compose.hetzner-unified.yml` — Added `META_TOOLS_MODE` env var
- `.env.example` — Documented `META_TOOLS_MODE`

**How it works**:
- `META_TOOLS_MODE=false` (default): All tools show individually (backward compatible)
- `META_TOOLS_MODE=true`: OpenAPI spec shows only 3 meta-tools, 96-99% token reduction
- Embeddings auto-generated during `refresh_tools_cache()` and stored in pgvector
- Access control enforced on all meta-tool calls (group-based tenant filtering)

## PRD Status

| Story | Phase | Status |
|---|---|---|
| US-001: Deploy to Hetzner | 1 | Done |
| US-002: Single proxy URL | 1 | Done |
| US-003: Auto-deploy from Git | 1 | Done |
| US-004: Schema migration | 2 | Done (today) |
| US-005: Safety documentation | 2 | Done (today) |
| US-006: Auto-enable fix | 2 | Done (today) |
| US-007: Native MCP research | 2 | Done (today) |
| US-008: Progressive disclosure | 3 | Done (today) |
| US-009: Admin portal | 3 | Pending |
| US-010: Monitoring/alerts | 3 | Pending |
| US-011: Load testing | 3 | Pending |

**8 of 11 stories complete. Phase 1 + Phase 2 complete. Phase 3 has 3 remaining.**

## Deployment

To enable meta-tools on Hetzner:
```bash
# In /root/IO/.env, add:
META_TOOLS_MODE=true

# Rebuild and restart
docker compose -f docker-compose.hetzner-unified.yml up -d --build mcp-proxy

# Run migration for new table
docker exec -i postgres psql -U openwebui -d openwebui < scripts/init-db-hetzner.sql

# Refresh tools + generate embeddings
curl -X POST http://localhost:8000/refresh

# Check stats
curl http://localhost:8000/meta/stats
```
